{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OverClockers</title>
    <link rel="stylesheet" href="{% static 'assistant/css/chat.css' %}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-logo">
                <img src="{% static 'assistant/img/logo.svg' %}" alt="Logo" class="logo-img">
            </div>
            
            <div class="header-content">
                <h1>ü§ñ –†–æ–±–µ—Ä—Ç AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h1>
                <p>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤—ã–±–æ—Ä—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</p>
            </div>
            <button class="manager-btn" id="managerBtn" onclick="requestManager()" title="–ü–æ–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä
            </button>
            <button class="clear-chat-btn" onclick="clearChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                üóëÔ∏è
            </button>
        </div>
        <div class="manager-banner" id="managerBanner" style="display: none;">
            <span id="managerStatus">üîî –û–∂–∏–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞...</span>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p><strong>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã</strong></p>
                    <p>–Ø –†–æ–±–µ—Ä—Ç, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–∞–≥–∞–∑–∏–Ω–∞ Over. –ü–æ–º–æ–≥—É –≤–∞–º:</p>
                    <ul>
                        <li>üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å —Å–º–∞—Ä—Ç—Ñ–æ–Ω, –Ω–æ—É—Ç–±—É–∫ –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</li>
                        <li>üí∞ –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –ø–æ –≤–∞—à–µ–º—É –±—é–¥–∂–µ—Ç—É</li>
                        <li>üì¶ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –æ–ø–ª–∞—Ç–µ</li>
                        <li>‚öôÔ∏è –ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º</li>
                    </ul>
                    
                    <div class="quick-questions">
                        <div class="quick-question" onclick="sendQuickQuestion('–ù—É–∂–µ–Ω –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–æ 50000 —Ç–µ–Ω–≥–µ')">
                            üéÆ –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –Ω–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã')">
                            üíº –ù–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É?')">
                            üöö –î–æ—Å—Ç–∞–≤–∫–∞
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ö–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã?')">
                            üí≥ –û–ø–ª–∞—Ç–∞
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <input type="file" id="fileInput" accept="image/*,.pdf,.xls,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
            <button class="attach-button" id="attachButton" onclick="document.getElementById('fileInput').click()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                üìé
            </button>
            <textarea
                class="chat-input"
                id="messageInput"
                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –∏—â–µ—Ç–µ..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <span class="send-icon">üì§</span>
                <span class="send-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
            </button>
        </div>
        <div id="filePreview" class="file-preview" style="display: none;">
            <span id="fileName"></span>
            <button onclick="removeFile()">‚úñ</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = '/assistant/api/chat/';
        const PRODUCT_API_URL = '/assistant/api/product/';
        
        // –°–µ—Å—Å–∏—è
        let sessionId = localStorage.getItem('chat_session_id');

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        let selectedFile = null;

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, isUser) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            let content = '';

            if (isUser) {
                content = `
                    <div class="message-content">
                        <p>${escapeHtml(text)}</p>
                    </div>
                    <div class="message-avatar">üë§</div>
                `;
            } else {
                content = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        ${formatMessage(text)}
                    </div>
                `;
            }

            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown)
        function formatMessage(text) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ** –≤ bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ * —Å–ø–∏—Å–∫–æ–≤
            text = text.replace(/^\* (.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            return '<p>' + text + '</p>';
        }


        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = show ? 'block' : 'none';
            if (show) scrollToBottom();
        }

        // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–≤–æ–¥
        function setInputEnabled(enabled) {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            input.disabled = !enabled;
            button.disabled = !enabled;
            
            if (enabled) {
                input.focus();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!allowedTypes.includes(file.type)) {
                    alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG, PNG), PDF –∏ Excel —Ñ–∞–π–ª—ã');
                    return;
                }

                if (file.size > maxSize) {
                    alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10MB');
                    return;
                }

                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('filePreview').style.display = 'block';
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message && !selectedFile) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const displayMessage = selectedFile ? `${message || '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'} üìé ${selectedFile.name}` : message;
            addMessage(displayMessage, true);
            input.value = '';
            input.style.height = 'auto';

            // –û—Ç–∫–ª—é—á–∞–µ–º –≤–≤–æ–¥
            setInputEnabled(false);
            showTypingIndicator(true);

            try {
                const formData = new FormData();
                formData.append('message', message || '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                formData.append('session_id', sessionId || '');

                if (selectedFile) {
                    formData.append('file', selectedFile);
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º session_id
                    if (data.session_id) {
                        sessionId = data.session_id;
                        localStorage.setItem('chat_session_id', sessionId);
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
                    addMessage(data.response, false);
                } else {
                    addMessage('üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', false);
                }

                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                if (selectedFile) {
                    removeFile();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                addMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', false);
            } finally {
                showTypingIndicator(false);
                setInputEnabled(true);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        function sendQuickQuestion(question) {
            const input = document.getElementById('messageInput');
            input.value = question;
            sendMessage();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

            // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞
            async function showProductDetails(sku) {
            const modal = document.getElementById('productModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`${PRODUCT_API_URL}${sku}/`);
                const data = await response.json();
                
                if (data.success && data.product) {
                    const p = data.product;

                    // –û–±–µ —Ü–µ–Ω—ã
                    const creditPrice = p.credit ? formatPrice(p.credit) : 'N/A';
                    const bonusPrice = p.bonus ? formatPrice(p.bonus) : 'N/A';

                    modalBody.innerHTML = `
                        <h2>${escapeHtml(p.name)}</h2>
                        <div class="product-detail-full">
                            <div class="detail-row">
                                <span class="label">üí≥ –†–∞—Å—Å—Ä–æ—á–∫–∞:</span>
                                <span class="value price-large">${creditPrice} ‚Ç∏</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">üí∞ –°–∫–∏–¥–∫–∞ (–∫–∞—Ä—Ç–∞/–Ω–∞–ª–∏—á–Ω—ã–µ):</span>
                                <span class="value price-large">${bonusPrice} ‚Ç∏</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ë—Ä–µ–Ω–¥:</span>
                                <span class="value">${escapeHtml(p.brand)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ê—Ä—Ç–∏–∫—É–ª:</span>
                                <span class="value">${escapeHtml(p.article)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">SKU:</span>
                                <span class="value">${escapeHtml(p.sku)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ù–∞–ª–∏—á–∏–µ:</span>
                                <span class="value ${p.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                                    ${p.stock > 0 ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏—è:</span>
                                <span class="value">${escapeHtml(p.warranty)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span>
                                <span class="value">${escapeHtml(p.supplier)}</span>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button class="btn-primary" onclick="orderProduct('${p.sku}')">
                                –ó–∞–∫–∞–∑–∞—Ç—å
                            </button>
                            <button class="btn-secondary" onclick="askAboutProduct('${escapeHtml(p.name)}')">
                                –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
                            </button>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = '<p class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                modalBody.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // –ó–∞–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä
        function orderProduct(sku) {
            closeModal();
            const input = document.getElementById('messageInput');
            input.value = `–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä SKU: ${sku}`;
            sendMessage();
        }

        // –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ —Ç–æ–≤–∞—Ä–µ
        function askAboutProduct(productName) {
            closeModal();
            const input = document.getElementById('messageInput');
            input.value = `–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ ${productName}`;
            sendMessage();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        function clearChat() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                localStorage.removeItem('chat_session_id');
                sessionId = null;
                location.reload();
            }
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        function formatPrice(price) {
            return Number(price).toLocaleString('ru-RU');
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeModal();
            }
        }
       
       
        function escapeForJS(str) {
        return str.replace(/\\/g, '\\\\')  // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏
              .replace(/'/g, "\\'")    // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã
              .replace(/"/g, '\\"');   // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
        }

        // === –ú–ï–ù–ï–î–ñ–ï–† ===
        let withManager = false;
        let lastMessageId = 0;
        let pollingInterval = null;

        // –ó–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function requestManager() {
            if (!sessionId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º');
                return;
            }

            if (withManager) {
                alert('–í—ã —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –æ–±—â–µ–Ω–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º');
                return;
            }

            if (!confirm('–•–æ—Ç–∏—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º?')) return;

            try {
                const response = await fetch('/assistant/api/request-manager/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        reason: '–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–º–æ—â—å'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage(data.message, false);
                    setManagerMode(true, 'pending');
                    startPolling();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        function setManagerMode(active, status = 'pending') {
            withManager = active;
            const banner = document.getElementById('managerBanner');
            const statusText = document.getElementById('managerStatus');
            const managerBtn = document.getElementById('managerBtn');

            if (active) {
                banner.style.display = 'block';
                managerBtn.style.display = 'none';

                if (status === 'pending') {
                    statusText.textContent = 'üîî –û–∂–∏–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞...';
                    banner.style.background = '#fff3e0';
                } else if (status === 'with_manager') {
                    statusText.textContent = 'üë®‚Äçüíº –í—ã –æ–±—â–∞–µ—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º';
                    banner.style.background = '#e8f5e9';
                }
            } else {
                banner.style.display = 'none';
                managerBtn.style.display = 'inline-flex';
            }
        }

        // Polling –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function startPolling() {
            if (pollingInterval) return;

            pollingInterval = setInterval(async () => {
                if (!sessionId) return;

                try {
                    const response = await fetch(`/assistant/api/messages/${sessionId}/?last_id=${lastMessageId}`);
                    const data = await response.json();

                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                        if (data.with_manager) {
                            setManagerMode(true, data.session_status);
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach(msg => {
                                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
                                if (!msg.is_user) {
                                    addMessageFromPolling(msg);
                                }
                                lastMessageId = Math.max(lastMessageId, msg.id);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ polling
        function addMessageFromPolling(msg) {
            const messagesContainer = document.getElementById('chatMessages');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (document.querySelector(`[data-msg-id="${msg.id}"]`)) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.setAttribute('data-msg-id', msg.id);

            const avatar = msg.sender_type === 'manager' ? 'üë®‚Äçüíº' : 'ü§ñ';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${formatMessage(msg.message)}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ polling
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            document.getElementById('messageInput').focus();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            if (sessionId) {
                checkSessionStatus();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏
        async function checkSessionStatus() {
            try {
                const response = await fetch(`/assistant/api/status/${sessionId}/`);
                const data = await response.json();

                if (data.success && data.with_manager) {
                    setManagerMode(true, data.status);
                    startPolling();
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }
    </script>
</body>
</html>