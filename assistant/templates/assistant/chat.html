{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OverClockers</title>
    <link rel="stylesheet" href="{% static 'assistant/css/chat.css' %}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-logo">
                <img src="{% static 'assistant/img/logo.svg' %}" alt="Logo" class="logo-img">
            </div>
            
            <div class="header-content">
                <h1>ü§ñ –†–æ–±–µ—Ä—Ç AI –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h1>
                <p>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤—ã–±–æ—Ä—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</p>
            </div>
            <button class="clear-chat-btn" onclick="clearChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                üóëÔ∏è
            </button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p><strong>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã</strong></p>
                    <p>–Ø –†–æ–±–µ—Ä—Ç, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–∞–≥–∞–∑–∏–Ω–∞ Over. –ü–æ–º–æ–≥—É –≤–∞–º:</p>
                    <ul>
                        <li>üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å —Å–º–∞—Ä—Ç—Ñ–æ–Ω, –Ω–æ—É—Ç–±—É–∫ –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</li>
                        <li>üí∞ –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –ø–æ –≤–∞—à–µ–º—É –±—é–¥–∂–µ—Ç—É</li>
                        <li>üì¶ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –æ–ø–ª–∞—Ç–µ</li>
                        <li>‚öôÔ∏è –ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º</li>
                    </ul>
                    
                    <div class="quick-questions">
                        <div class="quick-question" onclick="sendQuickQuestion('–ù—É–∂–µ–Ω –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–æ 50000 —Ç–µ–Ω–≥–µ')">
                            üéÆ –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –Ω–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã')">
                            üíº –ù–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É?')">
                            üöö –î–æ—Å—Ç–∞–≤–∫–∞
                        </div>
                        <div class="quick-question" onclick="sendQuickQuestion('–ö–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã?')">
                            üí≥ –û–ø–ª–∞—Ç–∞
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <textarea 
                class="chat-input" 
                id="messageInput" 
                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –∏—â–µ—Ç–µ..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <span class="send-icon">üì§</span>
                <span class="send-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = '/assistant/api/chat/';
        const PRODUCT_API_URL = '/assistant/api/product/';
        
        // –°–µ—Å—Å–∏—è
        let sessionId = localStorage.getItem('chat_session_id');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, isUser, products = []) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            let content = '';
            
            if (isUser) {
                content = `
                    <div class="message-content">
                        <p>${escapeHtml(text)}</p>
                    </div>
                    <div class="message-avatar">üë§</div>
                `;
            } else {
                content = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        ${formatMessage(text)}
                        ${products && products.length > 0 ? renderProducts(products) : ''}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown)
        function formatMessage(text) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ** –≤ bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ * —Å–ø–∏—Å–∫–æ–≤
            text = text.replace(/^\* (.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            return '<p>' + text + '</p>';
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤
        function renderProducts(products) {
            let html = '<div class="products-grid">';
            
            products.forEach(product => {
                const inStock = product.stock > 0;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ credit, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º N/A
                const currentPrice = product.credit ? formatPrice(product.credit) : 'N/A';
                
                html += `
                    <div class="product-card ${inStock ? '' : 'out-of-stock'}" onclick="showProductDetails('${product.sku}')">
                        <h4>${escapeHtml(product.name)}</h4>
                        
                        <div class="product-price">
                            ${currentPrice} ‚Ç∏
                        </div>
                        
                        <div class="product-details">
                            <div class="product-detail-item">
                                <span class="detail-label">–ë—Ä–µ–Ω–¥:</span>
                                <span class="detail-value">${escapeHtml(product.brand)}</span>
                            </div>
                            <div class="product-detail-item">
                                <span class="detail-label">–ù–∞–ª–∏—á–∏–µ:</span>
                                <span class="detail-value ${inStock ? 'in-stock' : 'out-of-stock'}">
                                    ${inStock ? `‚úÖ ${product.stock} —à—Ç.` : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                                </span>
                            </div>
                            <div class="product-detail-item">
                                <span class="detail-label">–ì–∞—Ä–∞–Ω—Ç–∏—è:</span>
                                <span class="detail-value">${escapeHtml(product.warranty)}</span>
                            </div>
                        </div>
                        
                        <div class="product-badges">
                            ${inStock ? '<span class="badge badge-success">–í –Ω–∞–ª–∏—á–∏–∏</span>' : ''}
                            </div>
                        
                        <div class="product-actions">
                            <button class="btn-details" onclick="event.stopPropagation(); showProductDetails('${product.sku}')">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = show ? 'block' : 'none';
            if (show) scrollToBottom();
        }

        // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–≤–æ–¥
        function setInputEnabled(enabled) {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            input.disabled = !enabled;
            button.disabled = !enabled;
            
            if (enabled) {
                input.focus();
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessage(message, true);
            input.value = '';
            input.style.height = 'auto';
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –≤–≤–æ–¥
            setInputEnabled(false);
            showTypingIndicator(true);
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º session_id
                    if (data.session_id) {
                        sessionId = data.session_id;
                        localStorage.setItem('chat_session_id', sessionId);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                    addMessage(data.response, false, data.products || []);
                } else {
                    addMessage('üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', false);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                addMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', false);
            } finally {
                showTypingIndicator(false);
                setInputEnabled(true);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        function sendQuickQuestion(question) {
            const input = document.getElementById('messageInput');
            input.value = question;
            sendMessage();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

            // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞
            async function showProductDetails(sku) {
            const modal = document.getElementById('productModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`${PRODUCT_API_URL}${sku}/`);
                const data = await response.json();
                
                if (data.success && data.product) {
                    const p = data.product;
                    
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ price-large –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç credit
                    const currentPrice = p.credit ? formatPrice(p.credit) : 'N/A';
                    
                    modalBody.innerHTML = `
                        <h2>${escapeHtml(p.name)}</h2>
                        <div class="product-detail-full">
                            <div class="detail-row">
                                <span class="label">–¶–µ–Ω–∞ (Credit):</span>
                                <span class="value price-large">${currentPrice} ‚Ç∏</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ë—Ä–µ–Ω–¥:</span>
                                <span class="value">${escapeHtml(p.brand)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ê—Ä—Ç–∏–∫—É–ª:</span>
                                <span class="value">${escapeHtml(p.article)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">SKU:</span>
                                <span class="value">${escapeHtml(p.sku)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ù–∞–ª–∏—á–∏–µ:</span>
                                <span class="value ${p.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                                    ${p.stock > 0 ? `‚úÖ ${p.stock} —à—Ç.` : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ì–∞—Ä–∞–Ω—Ç–∏—è:</span>
                                <span class="value">${escapeHtml(p.warranty)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span>
                                <span class="value">${escapeHtml(p.supplier)}</span>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn-primary" onclick="orderProduct('${p.sku}')">
                                –ó–∞–∫–∞–∑–∞—Ç—å
                            </button>
                            <button class="btn-secondary" onclick="askAboutProduct('${escapeHtml(p.name)}')">
                                –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
                            </button>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = '<p class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                modalBody.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // –ó–∞–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä
        function orderProduct(sku) {
            closeModal();
            const input = document.getElementById('messageInput');
            input.value = `–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä SKU: ${sku}`;
            sendMessage();
        }

        // –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ —Ç–æ–≤–∞—Ä–µ
        function askAboutProduct(productName) {
            closeModal();
            const input = document.getElementById('messageInput');
            input.value = `–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ ${productName}`;
            sendMessage();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        function clearChat() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                localStorage.removeItem('chat_session_id');
                sessionId = null;
                location.reload();
            }
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        function formatPrice(price) {
            return Number(price).toLocaleString('ru-RU');
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeModal();
            }
        }
       
       
        function escapeForJS(str) {
        return str.replace(/\\/g, '\\\\')  // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏
              .replace(/'/g, "\\'")    // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã
              .replace(/"/g, '\\"');   // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
        }

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            document.getElementById('messageInput').focus();
        }
    </script>
</body>
</html>